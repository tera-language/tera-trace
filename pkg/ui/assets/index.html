<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TeraTrace Local</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg-base: #0a0812;
        --bg-grid: #1a162d;
        --panel-bg: rgba(18, 14, 34, 0.98);
        --panel-border: #9d7df533;
        --accent: #9d7df5;
        --accent-bright: #bc9aff;
        --accent-glow: rgba(157, 125, 245, 0.4);
        --text-main: #b4acc9;
        --info: #7dcfff;
        --warn: #ff9e64;
        --error: #ff007c;
        --grid-size: 20px;
        --topbar-h: 54px;
      }

      body {
        margin: 0; padding: 0;
        background-color: var(--bg-base);
        background-image: linear-gradient(to right, var(--bg-grid) 1px, transparent 1px),
                          linear-gradient(to bottom, var(--bg-grid) 1px, transparent 1px);
        background-size: var(--grid-size) var(--grid-size);
        color: var(--text-main);
        font-family: "Inter", sans-serif;
        height: 100vh;
        overflow: hidden;
      }

      #topbar {
        height: var(--topbar-h);
        background: rgba(12, 10, 24, 0.95);
        border-bottom: 1px solid var(--panel-border);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 24px;
        backdrop-filter: blur(12px);
        position: relative;
        z-index: 10000;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }
      .brand { display: flex; align-items: center; gap: 12px; }
      .logo-sq {
        width: 28px; height: 28px;
        background: linear-gradient(135deg, var(--accent), var(--accent-bright));
        border-radius: 6px; display: grid; place-items: center;
        color: #000; font-weight: 900; font-size: 16px;
        box-shadow: 0 0 15px var(--accent-glow);
      }
      .brand-text { font-weight: 800; letter-spacing: 2.5px; color: #fff; font-size: 15px; }
      .status-pill {
        background: rgba(255, 255, 255, 0.03);
        padding: 5px 14px; border-radius: 20px; font-size: 10px;
        border: 1px solid var(--panel-border);
        display: flex; align-items: center; gap: 10px; color: #fff;
      }
      .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--warn); box-shadow: 0 0 10px var(--warn); transition: 0.3s; }
      .dot.online { background: #9ece6a; box-shadow: 0 0 10px #9ece6a; }

      #workspace { position: relative; width: 100vw; height: calc(100vh - var(--topbar-h)); }

      .component {
        position: absolute; display: flex; flex-direction: column;
        background: var(--panel-bg); border: 1px solid var(--panel-border);
        border-radius: 10px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        overflow: hidden; backdrop-filter: blur(16px);
      }
      .component.moving { opacity: 0.9; border-color: var(--accent-bright); z-index: 9999 !important; }
      .component.invalid { border-color: var(--error); box-shadow: 0 0 25px rgba(255, 0, 124, 0.3); }

      .comp-header {
        padding: 12px 16px; background: rgba(157, 125, 245, 0.08);
        border-bottom: 1px solid var(--panel-border); cursor: grab;
        display: flex; justify-content: space-between; align-items: center;
      }
      .comp-title { font-size: 10px; font-weight: 800; color: var(--accent-bright); letter-spacing: 1.5px; text-transform: uppercase; }

      .comp-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 14px; }

      /* Analytics Visual Improvement */
      .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--panel-border);
        border-radius: 8px; padding: 12px; margin-bottom: 10px;
      }
      .stat-service-name { font-size: 11px; font-weight: 700; color: #fff; margin-bottom: 8px; display: block; text-transform: uppercase; }
      .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
      .badge {
        display: flex; flex-direction: column; align-items: center;
        padding: 6px; border-radius: 6px; font-size: 10px; font-weight: 700;
        background: rgba(255, 255, 255, 0.03); border: 1px solid transparent;
      }
      .badge.info { border-color: var(--info); color: var(--info); }
      .badge.warn { border-color: var(--warn); color: var(--warn); }
      .badge.error { border-color: var(--error); color: var(--error); }
      .badge-val { font-size: 14px; margin-top: 2px; }

      #logContainer { flex: 1; overflow-y: auto; font-family: "Fira Code", monospace; font-size: 12px; }
      .log-line { padding: 7px 12px; border-bottom: 1px solid rgba(157, 125, 245, 0.05); cursor: pointer; border-left: 3px solid transparent; }
      .INFO { border-left-color: var(--info); }
      .WARN { border-left-color: var(--warn); }
      .ERROR { border-left-color: var(--error); background: rgba(255, 0, 124, 0.04); }
      .metadata { display: none; background: #08060d; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid var(--panel-border); white-space: pre-wrap; }
      .expanded .metadata { display: block; }

      .toolbar { display: flex; gap: 8px; margin-bottom: 14px; }
      input, select, button { background: #141120; border: 1px solid var(--panel-border); color: #fff; padding: 7px 14px; border-radius: 6px; font-size: 11px; }
      button { cursor: pointer; border-color: var(--accent); color: var(--accent); font-weight: bold; background: transparent; }
      button:hover { background: var(--accent); color: #000; }

      .service-item { padding: 12px; margin-bottom: 6px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; background: rgba(157, 125, 245, 0.03); }
      .service-item.active { background: rgba(157, 125, 245, 0.15); border: 1px solid var(--accent); color: #fff; }

      .resizer { width: 16px; height: 16px; position: absolute; right: 0; bottom: 0; cursor: nwse-resize; background: linear-gradient(135deg, transparent 70%, var(--accent-bright) 70%); }
    </style>
  </head>
  <body>
    <div id="topbar">
      <div class="brand">
        <div class="logo-sq">T</div>
        <div class="brand-text">TERATRACE <span style="opacity: 0.4; font-weight: 400">Local</span></div>
      </div>
      <div class="status-pill">
        <div id="global-dot" class="dot"></div>
        <span id="global-status">SYSTEM OFFLINE</span>
      </div>
    </div>

    <div id="workspace"></div>

    <script>
      const STORAGE_KEY = "teraTrace_v2";
      const GRID_SIZE = 20;
      const TOPBAR_H = 54;
      const workspace = document.getElementById("workspace");

      const state = { logs: {}, activeService: null, autoScroll: true, highestZ: 100 };
      const constraints = { tree: { minW: 220, minH: 300 }, logs: { minW: 450, minH: 300 }, stats: { minW: 300, minH: 260 } };

      const defaultLayout = [
        { id: "tree-p", type: "tree", x: 20, y: 20, w: 260, h: 600, title: "Services" },
        { id: "logs-p", type: "logs", x: 300, y: 20, w: 800, h: 700, title: "Terminal Feed" },
        { id: "stats-p", type: "stats", x: 1120, y: 20, w: 340, h: 400, title: "Analytics" }
      ];

      let layout = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultLayout;
      const snap = (v) => Math.round(v / GRID_SIZE) * GRID_SIZE;

      function checkOverlap(id, x, y, w, h) {
        const panels = document.querySelectorAll(".component");
        for (let p of panels) {
          if (p.id === id) continue;
          const r1 = { left: x, top: y, right: x + w, bottom: y + h };
          const r2 = { left: p.offsetLeft, top: p.offsetTop, right: p.offsetLeft + p.offsetWidth, bottom: p.offsetTop + p.offsetHeight };
          if (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom)) return true;
        }
        return false;
      }

      function createComponent(config) {
        const comp = document.createElement("div");
        comp.className = "component";
        comp.id = config.id;
        comp.dataset.type = config.type;
        comp.style.cssText = `left:${config.x}px;top:${config.y}px;width:${config.w}px;height:${config.h}px;z-index:${state.highestZ};`;
        comp.innerHTML = `
          <div class="comp-header">
              <span class="comp-title">${config.title}</span>
              <span style="font-size:9px; color:var(--accent); opacity:0.6">${config.type.toUpperCase()}</span>
          </div>
          <div class="comp-body">
              ${config.type === "tree" ? '<div id="treeList"></div>' : 
                config.type === "logs" ? `
                <div class="toolbar">
                    <select id="levelFilter"><option value="">ALL LEVELS</option><option value="INFO">INFO</option><option value="WARN">WARN</option><option value="ERROR">ERROR</option></select>
                    <input type="text" id="searchFilter" placeholder="Filter..." style="flex:1">
                    <button id="clearBtn">PURGE</button>
                </div>
                <div id="logContainer"></div>` : 
                '<div id="statsContent" style="overflow-y:auto"></div>'
              }
          </div>
          <div class="resizer"></div>`;
        workspace.appendChild(comp);
        attachInteractions(comp);
      }

      function attachInteractions(el) {
        const header = el.querySelector(".comp-header"), resizer = el.querySelector(".resizer");
        const limit = constraints[el.dataset.type];
        let oldX, oldY, oldW, oldH;

        el.onmousedown = () => { el.style.zIndex = ++state.highestZ; };

        header.onmousedown = (e) => {
          if (["BUTTON", "SELECT", "INPUT"].includes(e.target.tagName)) return;
          el.classList.add("moving");
          oldX = el.offsetLeft; oldY = el.offsetTop;
          let startX = e.clientX - el.offsetLeft, startY = e.clientY - el.offsetTop;

          document.onmousemove = (e) => {
            let newX = e.clientX - startX;
            let newY = e.clientY - startY;
            el.style.left = newX + "px";
            el.style.top = newY + "px";
            
            const isInvalid = checkOverlap(el.id, newX, newY, el.offsetWidth, el.offsetHeight) || newY < 0;
            el.classList.toggle("invalid", isInvalid);
          };

          document.onmouseup = () => {
            document.onmousemove = null;
            el.classList.remove("moving");
            let finalX = snap(el.offsetLeft), finalY = snap(el.offsetTop);

            // Constraint: Cannot place in top bar area (Y < 0 relative to workspace)
            if (finalY < 0 || checkOverlap(el.id, finalX, finalY, el.offsetWidth, el.offsetHeight)) {
              el.style.left = oldX + "px";
              el.style.top = oldY + "px";
            } else {
              el.style.left = finalX + "px";
              el.style.top = finalY + "px";
            }
            el.classList.remove("invalid");
            saveLayout();
          };
        };

        resizer.onmousedown = (e) => {
          e.preventDefault();
          el.classList.add("moving");
          oldW = el.offsetWidth; oldH = el.offsetHeight;
          let startX = e.clientX, startY = e.clientY;

          document.onmousemove = (e) => {
            let newW = Math.max(limit.minW, oldW + (e.clientX - startX));
            let newH = Math.max(limit.minH, oldH + (e.clientY - startY));
            el.style.width = newW + "px";
            el.style.height = newH + "px";
            el.classList.toggle("invalid", checkOverlap(el.id, el.offsetLeft, el.offsetTop, newW, newH));
          };

          document.onmouseup = () => {
            document.onmousemove = null;
            el.classList.remove("moving");
            let fW = snap(el.offsetWidth), fH = snap(el.offsetHeight);
            if (checkOverlap(el.id, el.offsetLeft, el.offsetTop, fW, fH)) {
              el.style.width = oldW + "px"; el.style.height = oldH + "px";
            } else {
              el.style.width = fW + "px"; el.style.height = fH + "px";
            }
            el.classList.remove("invalid");
            saveLayout();
          };
        };
      }

      function setupWebSocket() {
        const ws = new WebSocket("ws://localhost:8081/ws");
        const dot = document.getElementById("global-dot");
        const statusText = document.getElementById("global-status");

        ws.onopen = () => { dot.classList.add("online"); statusText.innerText = "GATEWAY CONNECTED"; };
        ws.onmessage = (event) => {
          const log = JSON.parse(event.data);
          if (!state.logs[log.Service]) state.logs[log.Service] = [];
          state.logs[log.Service].push(log);
          if (state.logs[log.Service].length > 500) state.logs[log.Service].shift();
          if (!state.activeService) state.activeService = log.Service;

          updateTreeUI();
          if (state.activeService === log.Service) appendLogUI(log);
          updateStats();
        };
        ws.onclose = () => {
          dot.classList.remove("online");
          statusText.innerText = "GATEWAY DISCONNECTED";
          setTimeout(setupWebSocket, 3000);
        };
      }

      function appendLogUI(log) {
        const container = document.getElementById("logContainer");
        if (!container) return;
        const fLvl = document.getElementById("levelFilter").value;
        const fSrc = document.getElementById("searchFilter").value.toLowerCase();
        if (fLvl && log.Level !== fLvl) return;
        if (fSrc && !log.Message.toLowerCase().includes(fSrc)) return;

        const div = document.createElement("div");
        div.className = `log-line ${log.Level}`;
        div.innerHTML = `<span style="opacity:0.4; font-size:10px">${new Date(log.Timestamp).toLocaleTimeString()}</span> <b>${log.Level}</b> ${log.Message}
                        <div class="metadata">TraceID: ${log.TraceID}\nSession: ${log.SessionID}\n${JSON.stringify(log.Metadata, null, 2)}</div>`;
        div.onclick = () => div.classList.toggle("expanded");
        container.appendChild(div);
        if (state.autoScroll) container.scrollTop = container.scrollHeight;
      }

      function updateTreeUI() {
        const tree = document.getElementById("treeList");
        if (!tree) return;
        tree.innerHTML = Object.keys(state.logs).map(s => `
          <div class="service-item ${s === state.activeService ? "active" : ""}" onclick="window.setService('${s}')">
              <span>${s}</span><span style="opacity:0.5">${state.logs[s].length}</span>
          </div>`).join("");
      }

      window.setService = (svc) => {
        state.activeService = svc;
        updateTreeUI();
        const container = document.getElementById("logContainer");
        if (container) {
          container.innerHTML = "";
          (state.logs[svc] || []).forEach(appendLogUI);
        }
      };

      function updateStats() {
        const content = document.getElementById("statsContent");
        if (!content) return;
        let html = "";
        for (let s in state.logs) {
          const counts = { INFO: 0, WARN: 0, ERROR: 0 };
          state.logs[s].forEach(l => counts[l.Level]++);
          html += `
            <div class="stat-card">
              <span class="stat-service-name">${s}</span>
              <div class="stat-grid">
                <div class="badge info"><span>INFO</span><span class="badge-val">${counts.INFO}</span></div>
                <div class="badge warn"><span>WARN</span><span class="badge-val">${counts.WARN}</span></div>
                <div class="badge error"><span>ERROR</span><span class="badge-val">${counts.ERROR}</span></div>
              </div>
            </div>`;
        }
        content.innerHTML = html;
      }

      function saveLayout() {
        const current = layout.map(item => {
          const el = document.getElementById(item.id);
          return { ...item, x: el.offsetLeft, y: el.offsetTop, w: el.offsetWidth, h: el.offsetHeight };
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(current));
      }

      function bindEvents() {
        setTimeout(() => {
          const lvlF = document.getElementById("levelFilter");
          const srcF = document.getElementById("searchFilter");
          if(lvlF) lvlF.onchange = () => window.setService(state.activeService);
          if(srcF) srcF.oninput = () => window.setService(state.activeService);
          const clrB = document.getElementById("clearBtn");
          if(clrB) clrB.onclick = () => { if (state.activeService) state.logs[state.activeService] = []; window.setService(state.activeService); };
          const logBox = document.getElementById("logContainer");
          if (logBox) logBox.onscroll = () => { state.autoScroll = logBox.scrollHeight - logBox.scrollTop <= logBox.clientHeight + 60; };
        }, 300);
      }

      layout.forEach(createComponent);
      setupWebSocket();
      bindEvents();
    </script>
  </body>
</html>